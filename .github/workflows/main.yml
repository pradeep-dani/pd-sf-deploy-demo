name: Salesforce Manifest Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        type: choice
        options:
          - STAGING
          - FULL
          - PROD

jobs:
  DEPLOY_PROCESS:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }} # Or Staging, etc., if you use GitHub Environments for stricter control

    steps:
      - name: Check user permissions
        id: check_user
        run: |
          echo "Triggered by: ${{ github.actor }}"
          if [[ "${{ github.event.inputs.environment }}" != "STAGING" ]]; then
            if [[ "${{ github.actor }}" != "pradeep-dani1" && "${{ github.actor }}" != "pradeep-dani2" ]]; then
              echo "❌ Unauthorized to deploy to ${{ github.event.inputs.environment }}"
              exit 1
            fi
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }} # Checkout the specified branch
      
      - name: Read and parse JSON
        id: parse
        run: |
          content=$(cat .github/config/input.json)
          echo "manifest=$(echo $content | jq -r '.STAGING.manifest')" >> $GITHUB_OUTPUT
          echo "test_classes=$(echo $content | jq -r '.STAGING.test_classes')" >> $GITHUB_OUTPUT
          echo "is_validate=$(echo $content | jq -r '.STAGING.is_validate')" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Recommended Node.js version for sf CLI

      - name: Get npm cache directory
        id: npm-cache-dir
        run: echo "dir=$(npm config get cache)" >> $GITHUB_OUTPUT

      - name: Cache Salesforce CLI (npm modules and binaries)
        uses: actions/cache@v4
        id: cache-sf-cli
        with:
          path: |
            ${{ steps.npm-cache-dir.outputs.dir }}
            ~/.local/share/sf # Common install location for sf CLI
            ~/.npm
          key: ${{ runner.os }}-sf-cli-${{ hashFiles('**/package-lock.json', '.github/workflows/main.yml') }}
          restore-keys: |
            ${{ runner.os }}-sf-cli-

      - name: Install Salesforce CLI
        if: steps.cache-sf-cli.outputs.cache-hit != 'true'
        run: npm install @salesforce/cli --global

      - name: Add sf CLI to PATH
        run: |
          echo "$(npm config get prefix)/bin" >> $GITHUB_PATH
          echo "~/.local/share/sf/bin" >> $GITHUB_PATH # Ensure this path is added
          sf --version # Verify installation and path

      - name: Create JWT private key file
        run: |
          echo "${{ secrets.SFDX_JWT_KEY }}" > server.key
          chmod 600 server.key # Set restrictive permissions for security

      - name: Authenticate with Salesforce using JWT
        run: |
          sf org login jwt \
            --client-id ${{ secrets.SFDX_CLIENT_ID }} \
            --jwt-key-file server.key \
            --username ${{ secrets.SFDX_USERNAME }} \
            --instance-url ${{ secrets.SFDX_INSTANCE_URL }} \
            --alias env-${{ github.event.inputs.environment  }} 
        env:
          # You can optionally define secrets as environment variables here as well
          # SF_LOG_LEVEL: debug # For more verbose sf CLI output during auth
          SF_AUTOUPDATE_DISABLE: 'true' # Prevent sf CLI from trying to self-update during workflow

      - name: Deploy Salesforce project using manifest
        run: |
          if [ "${{ steps.parse.outputs.is_validate }}" = "true" ]; then            
            sf project deploy validate \
              --manifest ${{ steps.parse.outputs.manifest }} \
              --target-org env-${{ github.event.inputs.environment }} \
              --test-level RunSpecifiedTests ${{ steps.parse.outputs.test_classes }} \
              --verbose 
          else
            sf project deploy start \
              --manifest ${{ steps.parse.outputs.manifest }} \
              --target-org env-${{ github.event.inputs.environment }} \
              --test-level RunSpecifiedTests ${{ steps.parse.outputs.test_classes }} \
              --verbose 
          fi

      - name: Clean up private key file
        run: rm server.key
        if: always() # Ensure this runs even if previous steps fail for security